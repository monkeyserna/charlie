<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Charlie drive</title>
    <style>
        html, body, iframe, div {
            height: 100%;
            width: 100%;
            margin: 0;
            border: 0;
            overflow:hidden;
        }
        #container{position:relative;float:left;}
        #overlay{top:0;left:0;width:100%;height:100%;position:absolute;}
    </style>
    <script type="text/javascript" src="js/values.js"></script>
    <script type="text/javascript" src="phonegap.js"></script>
</head>
<body>
<!--<div onclick="onTap();">-->
<!--<iframe onload="iframeclick();" contenteditable="false"></iframe>-->
<!--</div>-->

<div id="container">
    <iframe id="camframe" src="driveCam.html" ></iframe>
    <div id="overlay"></div>
</div>

<script type="text/javascript" >
    var watchID = null;
    var websocket = null;
    var state = false;

    document.addEventListener("deviceready", onDeviceReady, false);



    document.getElementById("overlay").onclick = onTap;

    function onDeviceReady() {
        toast("Waiting for accelerometer")
        connectWS();
    }

    function connectWS(){
        websocket = new WebSocket(WEBHOST);

        websocket.onopen = function(evt) {
            toast("Connected. Ready to start")
            //startWatch()
        };

        websocket.onerror = function(evt) {
            websocket.close();
            connectWS();
        };
    }

    function startWatch() {
        var options = { frequency: ACCELEROMETER_FREQUENCY };
        watchID = navigator.accelerometer.watchAcceleration(onAccelerometerChanged, onAccelerometerError, options);
    }

    function onAccelerometerChanged(acceleration) {
        var msg = formatAcceleration(acceleration)
        var element = document.getElementById('accelerometer');

//            element.innerHTML = 'X: '   + acceleration.x + '<br />' +
//                    'Y: '               + acceleration.y + '<br />' +
//                    'Z: '               + acceleration.z + '<br />' +
//                    'Timestamp: '       + acceleration.timestamp + '<br />'+
//                    'MSG: '             + msg[0] + "-" + msg[1] + "-" + msg[2] + "-" + '<br />';

        websocket.send(msg)
        //websocket.send(acceleration.x+";"+acceleration.y+";"+acceleration.z+";"+acceleration.timestamp)
    }


    function formatAcceleration(acceleration){
        var res = new Uint8Array(3)
        res[0] = CMD_MOVE_FORWARD;
        res[1] = map(acceleration.x * 100,0,1000,255,0)
        res[2] = map(acceleration.y * 100,-1000,1000,0,255)
        return res
    }

    function stopWatch() {
        if (watchID) {
            navigator.accelerometer.clearWatch(watchID);
            watchID = null;
        }
    }

    function disconnectWS(){
        websocket.close();
    }

    function onAccelerometerError() {
        alert('onError!');
    }

    function stopCharlie(){
        var msg = new Uint8Array(3)
        msg[0] = CMD_STOP;
        msg[1] = CMD_NOPARAM
        msg[2] = CMD_NOPARAM
        websocket.send(msg)
        stopWatch()
    }

    function toast(msg){
        window.plugins.toast.showLongBottom(msg,
                function(a){console.log('toast success: ' + a)},
                function(b){console.log('toast error: ' + b)})
    }



    function onTap(){
        if (state){
            stopCharlie();
            state = false;
            toast("STOPPED");
        }
        else{
            startWatch();
            state = true;
            toast("STARTED");
        }

//        toast(state?"START":"STOP");
//        state = !state;
    }
</script>
</body>
</html>
