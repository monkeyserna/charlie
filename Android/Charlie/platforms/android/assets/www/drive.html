<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Charlie drive</title>
    <link rel="stylesheet" href="css/index.css" />
    <style>
        html, body,iframe {
            height: 100%;
            width: 100%;
            margin: 0;
            border: 0;
            overflow:hidden;
        }


    </style>
    <script type="text/javascript" src="js/values.js"></script>
    <script type="text/javascript" src="phonegap.js"></script>
    <script type="text/javascript" charset="utf-8">

        function map(x, in_min, in_max, out_min, out_max){
            if 		(x < in_min) x = in_min;
            else if 	(x > in_max) x = in_max;
            return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
        }
        
        function loadCamFrame(){
           document.getElementById('camframe').src =  "http://"+SERVER_IP+":"+SERVER_CAM_PORT+"/";
        }

        var watchID = null;
        var websocket = null;

        document.addEventListener("deviceready", onDeviceReady, false);

        function onDeviceReady() {
            document.getElementById('accelerometer').innerHTML = "Waiting for accelerometer";
            connectWS();
        }

        function connectWS(){
            websocket = new WebSocket(WEBHOST);

            websocket.onopen = function(evt) {
                //document.getElementById('accelerometer').innerHTML = "Connected. Ready to start"
                startWatch()
            };

            websocket.onerror = function(evt) {
                websocket.close();
                connectWS();
            };
        }

        function startWatch() {
            var options = { frequency: ACCELEROMETER_FREQUENCY };
            watchID = navigator.accelerometer.watchAcceleration(onAccelerometerChanged, onAccelerometerError, options);
        }

        function onAccelerometerChanged(acceleration) {
            var msg = formatAcceleration(acceleration)
            var element = document.getElementById('accelerometer');

            element.innerHTML = 'X: '   + acceleration.x + '<br />' +
                    'Y: '               + acceleration.y + '<br />' +
                    'Z: '               + acceleration.z + '<br />' +
                    'Timestamp: '       + acceleration.timestamp + '<br />'+
                    'MSG: '             + msg[0] + "-" + msg[1] + "-" + msg[2] + "-" + '<br />';

            websocket.send(msg)
            //websocket.send(acceleration.x+";"+acceleration.y+";"+acceleration.z+";"+acceleration.timestamp)
        }

        function formatAcceleration(acceleration){
            var res = new Uint8Array(3)
            res[0] = CMD_MOVE_FORWARD
            res[1] = map(acceleration.x * 100,0,1000,255,0)
            res[2] = map(acceleration.y * 100,-1000,1000,0,255)
            return res
        }

        function stopWatch() {
            if (watchID) {
                navigator.accelerometer.clearWatch(watchID);
                watchID = null;
            }
        }

        function disconnectWS(){
            websocket.close();
        }

        function onAccelerometerError() {
            alert('onError!');
        }

        function stopCharlie(){
            var msg = new Uint8Array(3)
            msg[0] = CMD_STOP
            msg[1] = CMD_NOPARAM
            msg[2] = CMD_NOPARAM
            websocket.send(msg)
            stopWatch()
        }

    </script>
</head>
<body>
<a class="button" href="#" id="btStop">STOP</a>
<a class="button"  href="#" id="btStart">START</a>
<div id="accelerometer">Preparing...</div>
<iframe id="camframe" onload="loadCamFrame();"></iframe>

<script>
    document.getElementById('btStop').onclick = stopCharlie;
    document.getElementById('btStart').onclick = startWatch;
</script>
</body>
</html>
